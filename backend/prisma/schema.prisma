generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BattleMode {
  OFFICIAL_3ON3
  REGIONAL_CIRCUIT
  LONG_TRAINING
  CUSTOM
}

enum UserRole {
  ADMIN
  MEMBER
  VISITOR
}

enum UserStatus {
  ACTIVE
  BANNED
}

enum AccessKeyStatus {
  AVAILABLE
  CLAIMED
  REVOKED
}

enum WorkspacePermissionScope {
  PARTS_EDIT
  USERS_MANAGE
  ACCESS_KEYS_MANAGE
  PUNISHMENTS_MANAGE
  AUDIT_VIEW
}

enum PartShareScope {
  VIEW
  EDIT
}

enum PunishmentType {
  TEMP_BAN
  PARTS_LOCK
  KEYS_LOCK
  ACCOUNT_LIMIT
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_ROLE_CHANGED
  USER_PUNISHED
  USER_UNPUNISHED
  ACCESS_KEY_CREATED
  ACCESS_KEY_REVOKED
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  PART_PERMISSION_GRANTED
  PART_PERMISSION_REVOKED
  PASSWORD_RESET
  DATA_TRANSFERRED
}

enum TeamRole {
  OWNER
  MEMBER
}

enum TeamMembershipStatus {
  ACTIVE
  PENDING
}

enum TeamMissionStatus {
  OPEN
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

model Part {
  id        String   @id @default(cuid())
  userId    String
  name      String
  type      String
  variant   String?
  weight    Float?
  archetype String
  subArchetype String?
  tags      String?  @default("[]")
  notes     String?
  imageUrl  String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  combosAsBlade    Combo[] @relation("Blade")
  combosAsRatchet  Combo[] @relation("Ratchet")
  combosAsBit      Combo[] @relation("Bit")
  combosAsAssist   Combo[] @relation("AssistBlade")
  combosAsLockChip Combo[] @relation("LockChip")

  @@index([userId])
}

model Arena {
  id        String   @id @default(cuid())
  userId    String
  name      String
  model     String?
  tags      String?  @default("[]")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User   @relation(fields: [userId], references: [id])
  battles Battle[]

  @@index([userId])
}

model Combo {
  id           String   @id @default(cuid())
  userId       String
  name         String
  bladeId      String
  ratchetId    String
  bitId        String
  assistBladeId String?
  lockChipId   String?
  archetype String
  subArchetype String?
  tags      String?  @default("[]")
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String   @default("ACTIVE")

  user        User  @relation(fields: [userId], references: [id])

  blade       Part  @relation("Blade", fields: [bladeId], references: [id])
  ratchet     Part  @relation("Ratchet", fields: [ratchetId], references: [id])
  bit         Part  @relation("Bit", fields: [bitId], references: [id])
  assistBlade Part? @relation("AssistBlade", fields: [assistBladeId], references: [id])
  lockChip    Part? @relation("LockChip", fields: [lockChipId], references: [id])

  battlesAsComboA Battle[] @relation("ComboA")
  battlesAsComboB Battle[] @relation("ComboB")
  deckSlots      DeckSlot[]

  @@index([userId])
}

model Battle {
  id          String   @id @default(cuid())
  userId      String
  comboAId    String
  comboBId    String
  bladerAId   String?
  bladerBId   String?
  result      String
  mode        BattleMode @default(OFFICIAL_3ON3)
  score       String?
  victoryType String?
  turns       Json?
  arenaId     String?
  notes       String?
  occurredAt  DateTime? @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User  @relation(fields: [userId], references: [id])
  comboA Combo  @relation("ComboA", fields: [comboAId], references: [id])
  comboB Combo  @relation("ComboB", fields: [comboBId], references: [id])
  bladerA Blader? @relation("BladerA", fields: [bladerAId], references: [id])
  bladerB Blader? @relation("BladerB", fields: [bladerBId], references: [id])
  arena  Arena?  @relation(fields: [arenaId], references: [id])

  @@index([userId])
}

model Deck {
  id        String     @id @default(cuid())
  userId    String
  name      String
  side      String?
  notes     String?
  bladerId  String?
  maxTurns  Int        @default(3)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  blader Blader?  @relation(fields: [bladerId], references: [id])
  slots DeckSlot[]

  @@index([userId])
}

model DeckSlot {
  id        String   @id @default(cuid())
  deckId    String
  comboId   String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deck  Deck  @relation(fields: [deckId], references: [id])
  combo Combo @relation(fields: [comboId], references: [id])

  @@unique([deckId, position])
}

model Blader {
  id        String   @id @default(cuid())
  userId    String
  name      String
  nickname  String?
  age       Int?
  country   String?
  team      String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User    @relation(fields: [userId], references: [id])
  decks        Deck[]
  battlesAsA   Battle[] @relation("BladerA")
  battlesAsB   Battle[] @relation("BladerB")

  @@index([userId])
}

model AssistantSession {
  id         String  @id @default(cuid())
  userId     String
  label      String?
  lastRoute  String?
  context    Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  messages   AssistantMessage[]
  missions   AssistantMission[]

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AssistantMessage {
  id         String  @id @default(cuid())
  sessionId  String
  role       String
  content    String
  context    Json?
  createdAt  DateTime @default(now())

  session AssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model AssistantMission {
  id             String   @id @default(cuid())
  sessionId      String
  title          String
  description    String?
  category       String?
  status         String   @default("PENDING")
  blockingReason String?
  context        Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  session AssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model User {
  id        String     @id @default(cuid())
  name      String
  username  String     @unique
  email     String     @unique
  passwordHash String?
  passwordNote String?
  role      UserRole   @default(MEMBER)
  status    UserStatus @default(ACTIVE)
  battleMilestone Int  @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  parts     Part[]
  arenas    Arena[]
  combos    Combo[]
  battles   Battle[]
  decks     Deck[]
  bladers   Blader[]
  assistantSessions AssistantSession[]
  issuedKeys  AccessKey[] @relation("OwnerKeys")
  claimedKeys AccessKey[] @relation("ClaimedKeys")
  permissions WorkspacePermission[] @relation("UserPermissions")
  grantedPermissions WorkspacePermission[] @relation("GrantedPermissions")
  partShareGrants PartShareGrant[] @relation("PartShareOwners")
  partShareAccess PartShareGrant[] @relation("PartShareGrantees")
  punishments Punishment[] @relation("PunishmentTarget")
  punishmentsIssued Punishment[] @relation("PunishmentIssuer")
  auditLogs AdminAuditLog[] @relation("AuditActor")
  auditTargets AdminAuditLog[] @relation("AuditTarget")
  teamMemberships TeamMembership[]
  teamMessages TeamMessage[]
  teamsOwned Team[]
  missionsCreated TeamMission[] @relation("TeamMissionCreator")
  missionsAssigned TeamMission[] @relation("TeamMissionAssignee")
  missionsSubmitted TeamMission[] @relation("TeamMissionSubmitter")
  missionsApproved TeamMission[] @relation("TeamMissionApprover")
  posts           Post[]
  postComments    PostComment[]
  postLikes       PostLike[]
}

model AccessKey {
  id          String           @id @default(cuid())
  code        String           @unique
  status      AccessKeyStatus  @default(AVAILABLE)
  ownerId     String?
  claimedById String?
  maxUses     Int              @default(1)
  uses        Int              @default(0)
  revokedAt   DateTime?
  claimedAt   DateTime?
  createdAt   DateTime         @default(now())

  owner     User? @relation("OwnerKeys", fields: [ownerId], references: [id])
  claimedBy User? @relation("ClaimedKeys", fields: [claimedById], references: [id])

  @@index([ownerId])
  @@index([claimedById])
}

model WorkspacePermission {
  id          String                   @id @default(cuid())
  userId      String
  grantedById String
  scope       WorkspacePermissionScope
  notes       String?
  expiresAt   DateTime?
  revokedAt   DateTime?
  createdAt   DateTime                 @default(now())

  user      User @relation("UserPermissions", fields: [userId], references: [id])
  grantedBy User @relation("GrantedPermissions", fields: [grantedById], references: [id])

  @@index([userId, scope])
  @@index([grantedById])
}

model PartShareGrant {
  id         String          @id @default(cuid())
  ownerId    String
  granteeId  String
  scope      PartShareScope  @default(VIEW)
  notes      String?
  revokedAt  DateTime?
  createdAt  DateTime        @default(now())

  owner   User @relation("PartShareOwners", fields: [ownerId], references: [id])
  grantee User @relation("PartShareGrantees", fields: [granteeId], references: [id])

  @@unique([ownerId, granteeId, scope])
  @@index([granteeId, scope])
}

model Punishment {
  id         String         @id @default(cuid())
  userId     String
  issuedById String
  type       PunishmentType
  reason     String
  metadata   Json?
  startsAt   DateTime       @default(now())
  endsAt     DateTime?
  revokedAt  DateTime?
  createdAt  DateTime       @default(now())

  user     User @relation("PunishmentTarget", fields: [userId], references: [id])
  issuedBy User @relation("PunishmentIssuer", fields: [issuedById], references: [id])

  @@index([userId, revokedAt])
  @@index([issuedById])
}

model AdminAuditLog {
  id           String      @id @default(cuid())
  actorId      String
  action       AuditAction
  targetUserId String?
  targetType   String?
  targetId     String?
  metadata     Json?
  createdAt    DateTime    @default(now())

  actor      User  @relation("AuditActor", fields: [actorId], references: [id])
  targetUser User? @relation("AuditTarget", fields: [targetUserId], references: [id])

  @@index([action])
  @@index([targetUserId])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User           @relation(fields: [ownerId], references: [id])
  memberships TeamMembership[]
  messages    TeamMessage[]
  missions    TeamMission[]

  @@index([ownerId])
}

model TeamMembership {
  id        String                @id @default(cuid())
  teamId    String
  userId    String
  role      TeamRole              @default(MEMBER)
  status    TeamMembershipStatus  @default(ACTIVE)
  createdAt DateTime              @default(now())
  level     Int                   @default(1)
  xp        Int                   @default(0)
  canManageMissions Boolean       @default(false)
  lastXpAt  DateTime?

  team Team @relation(fields: [teamId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@index([userId])
}

model TeamMessage {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([teamId, createdAt])
}

model TeamMission {
  id             String            @id @default(cuid())
  teamId         String
  title          String
  description    String?
  xpReward       Int               @default(25)
  status         TeamMissionStatus @default(OPEN)
  createdById    String
  assignedToId   String?
  submittedById  String?
  submittedAt    DateTime?
  submissionNote String?
  reviewNote     String?
  approvedById   String?
  approvedAt     DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  team        Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy   User @relation("TeamMissionCreator", fields: [createdById], references: [id])
  assignedTo  User? @relation("TeamMissionAssignee", fields: [assignedToId], references: [id])
  submittedBy User? @relation("TeamMissionSubmitter", fields: [submittedById], references: [id])
  approvedBy  User? @relation("TeamMissionApprover", fields: [approvedById], references: [id])

  @@index([teamId])
  @@index([status])
}

model Post {
  id        String   @id @default(cuid())
  userId    String
  content   String
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author   User          @relation(fields: [userId], references: [id])
  comments PostComment[]
  likes    PostLike[]

  @@index([createdAt])
}

model PostComment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
}
