generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BattleMode {
  OFFICIAL_3ON3
  REGIONAL_CIRCUIT
  LONG_TRAINING
  CUSTOM
}

enum UserRole {
  ADMIN
  MEMBER
  VISITOR
}

enum UserStatus {
  ACTIVE
  BANNED
}

enum AccessKeyStatus {
  AVAILABLE
  CLAIMED
  REVOKED
}

model Part {
  id        String   @id @default(cuid())
  userId    String
  name      String
  type      String
  variant   String?
  weight    Float?
  archetype String
  subArchetype String?
  tags      String?  @default("[]")
  notes     String?
  imageUrl  String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  combosAsBlade    Combo[] @relation("Blade")
  combosAsRatchet  Combo[] @relation("Ratchet")
  combosAsBit      Combo[] @relation("Bit")
  combosAsAssist   Combo[] @relation("AssistBlade")
  combosAsLockChip Combo[] @relation("LockChip")

  @@index([userId])
}

model Arena {
  id        String   @id @default(cuid())
  userId    String
  name      String
  model     String?
  tags      String?  @default("[]")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User   @relation(fields: [userId], references: [id])
  battles Battle[]

  @@index([userId])
}

model Combo {
  id           String   @id @default(cuid())
  userId       String
  name         String
  bladeId      String
  ratchetId    String
  bitId        String
  assistBladeId String?
  lockChipId   String?
  archetype String
  subArchetype String?
  tags      String?  @default("[]")
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String   @default("ACTIVE")

  user        User  @relation(fields: [userId], references: [id])

  blade       Part  @relation("Blade", fields: [bladeId], references: [id])
  ratchet     Part  @relation("Ratchet", fields: [ratchetId], references: [id])
  bit         Part  @relation("Bit", fields: [bitId], references: [id])
  assistBlade Part? @relation("AssistBlade", fields: [assistBladeId], references: [id])
  lockChip    Part? @relation("LockChip", fields: [lockChipId], references: [id])

  battlesAsComboA Battle[] @relation("ComboA")
  battlesAsComboB Battle[] @relation("ComboB")
  deckSlots      DeckSlot[]

  @@index([userId])
}

model Battle {
  id          String   @id @default(cuid())
  userId      String
  comboAId    String
  comboBId    String
  bladerAId   String?
  bladerBId   String?
  result      String
  mode        BattleMode @default(OFFICIAL_3ON3)
  score       String?
  victoryType String?
  turns       Json?
  arenaId     String?
  notes       String?
  occurredAt  DateTime? @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User  @relation(fields: [userId], references: [id])
  comboA Combo  @relation("ComboA", fields: [comboAId], references: [id])
  comboB Combo  @relation("ComboB", fields: [comboBId], references: [id])
  bladerA Blader? @relation("BladerA", fields: [bladerAId], references: [id])
  bladerB Blader? @relation("BladerB", fields: [bladerBId], references: [id])
  arena  Arena?  @relation(fields: [arenaId], references: [id])

  @@index([userId])
}

model Deck {
  id        String     @id @default(cuid())
  userId    String
  name      String
  side      String?
  notes     String?
  bladerId  String?
  maxTurns  Int        @default(3)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  blader Blader?  @relation(fields: [bladerId], references: [id])
  slots DeckSlot[]

  @@index([userId])
}

model DeckSlot {
  id        String   @id @default(cuid())
  deckId    String
  comboId   String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deck  Deck  @relation(fields: [deckId], references: [id])
  combo Combo @relation(fields: [comboId], references: [id])

  @@unique([deckId, position])
}

model Blader {
  id        String   @id @default(cuid())
  userId    String
  name      String
  nickname  String?
  age       Int?
  country   String?
  team      String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User    @relation(fields: [userId], references: [id])
  decks        Deck[]
  battlesAsA   Battle[] @relation("BladerA")
  battlesAsB   Battle[] @relation("BladerB")

  @@index([userId])
}

model AssistantSession {
  id         String  @id @default(cuid())
  userId     String
  label      String?
  lastRoute  String?
  context    Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  messages   AssistantMessage[]
  missions   AssistantMission[]

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model AssistantMessage {
  id         String  @id @default(cuid())
  sessionId  String
  role       String
  content    String
  context    Json?
  createdAt  DateTime @default(now())

  session AssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model AssistantMission {
  id             String   @id @default(cuid())
  sessionId      String
  title          String
  description    String?
  category       String?
  status         String   @default("PENDING")
  blockingReason String?
  context        Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  session AssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model User {
  id        String     @id @default(cuid())
  name      String
  username  String     @unique
  passwordHash String?
  passwordNote String?
  role      UserRole   @default(MEMBER)
  status    UserStatus @default(ACTIVE)
  battleMilestone Int  @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  parts     Part[]
  arenas    Arena[]
  combos    Combo[]
  battles   Battle[]
  decks     Deck[]
  bladers   Blader[]
  assistantSessions AssistantSession[]
  issuedKeys  AccessKey[] @relation("OwnerKeys")
  claimedKeys AccessKey[] @relation("ClaimedKeys")
}

model AccessKey {
  id          String           @id @default(cuid())
  code        String           @unique
  status      AccessKeyStatus  @default(AVAILABLE)
  ownerId     String?
  claimedById String?
  maxUses     Int              @default(1)
  uses        Int              @default(0)
  revokedAt   DateTime?
  claimedAt   DateTime?
  createdAt   DateTime         @default(now())

  owner     User? @relation("OwnerKeys", fields: [ownerId], references: [id])
  claimedBy User? @relation("ClaimedKeys", fields: [claimedById], references: [id])

  @@index([ownerId])
  @@index([claimedById])
}
