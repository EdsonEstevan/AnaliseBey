generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BattleMode {
  OFFICIAL_3ON3
  REGIONAL_CIRCUIT
  LONG_TRAINING
  CUSTOM
}

model Part {
  id        String   @id @default(cuid())
  name      String
  type      String
  variant   String?
  weight    Float?
  archetype String
  subArchetype String?
  tags      String?  @default("[]")
  notes     String?
  imageUrl  String?
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  combosAsBlade    Combo[] @relation("Blade")
  combosAsRatchet  Combo[] @relation("Ratchet")
  combosAsBit      Combo[] @relation("Bit")
  combosAsAssist   Combo[] @relation("AssistBlade")
  combosAsLockChip Combo[] @relation("LockChip")
}

model Arena {
  id        String   @id @default(cuid())
  name      String
  model     String?
  tags      String?  @default("[]")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  battles Battle[]
}

model Combo {
  id           String   @id @default(cuid())
  name         String
  bladeId      String
  ratchetId    String
  bitId        String
  assistBladeId String?
  lockChipId   String?
  archetype String
  subArchetype String?
  tags      String?  @default("[]")
  notes     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String   @default("ACTIVE")

  blade       Part  @relation("Blade", fields: [bladeId], references: [id])
  ratchet     Part  @relation("Ratchet", fields: [ratchetId], references: [id])
  bit         Part  @relation("Bit", fields: [bitId], references: [id])
  assistBlade Part? @relation("AssistBlade", fields: [assistBladeId], references: [id])
  lockChip    Part? @relation("LockChip", fields: [lockChipId], references: [id])

  battlesAsComboA Battle[] @relation("ComboA")
  battlesAsComboB Battle[] @relation("ComboB")
  deckSlots      DeckSlot[]
}

model Battle {
  id          String   @id @default(cuid())
  comboAId    String
  comboBId    String
  bladerAId   String?
  bladerBId   String?
  result      String
  mode        BattleMode @default(OFFICIAL_3ON3)
  score       String?
  victoryType String?
  turns       Json?
  arenaId     String?
  notes       String?
  occurredAt  DateTime? @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  comboA Combo  @relation("ComboA", fields: [comboAId], references: [id])
  comboB Combo  @relation("ComboB", fields: [comboBId], references: [id])
  bladerA Blader? @relation("BladerA", fields: [bladerAId], references: [id])
  bladerB Blader? @relation("BladerB", fields: [bladerBId], references: [id])
  arena  Arena?  @relation(fields: [arenaId], references: [id])
}

model Deck {
  id        String     @id @default(cuid())
  name      String
  side      String?
  notes     String?
  bladerId  String?
  maxTurns  Int        @default(3)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  blader Blader?  @relation(fields: [bladerId], references: [id])
  slots DeckSlot[]
}

model DeckSlot {
  id        String   @id @default(cuid())
  deckId    String
  comboId   String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deck  Deck  @relation(fields: [deckId], references: [id])
  combo Combo @relation(fields: [comboId], references: [id])

  @@unique([deckId, position])
}

model Blader {
  id        String   @id @default(cuid())
  name      String
  nickname  String?
  age       Int?
  country   String?
  team      String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  decks        Deck[]
  battlesAsA   Battle[] @relation("BladerA")
  battlesAsB   Battle[] @relation("BladerB")
}

model AssistantSession {
  id         String  @id @default(cuid())
  label      String?
  lastRoute  String?
  context    Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  messages   AssistantMessage[]
  missions   AssistantMission[]
}

model AssistantMessage {
  id         String  @id @default(cuid())
  sessionId  String
  role       String
  content    String
  context    Json?
  createdAt  DateTime @default(now())

  session AssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

model AssistantMission {
  id             String   @id @default(cuid())
  sessionId      String
  title          String
  description    String?
  category       String?
  status         String   @default("PENDING")
  blockingReason String?
  context        Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  session AssistantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}
